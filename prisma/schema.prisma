// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id     String  @id @default(uuid())
  email  String  @unique
  name   String?
  role   UserRole @default(USER)
  avatar String?

  providers          OAuthProvider[]
  refreshTokens      RefreshToken[]
  authorizationCodes AuthorizationCode[]
  playlists          Playlist[]
  library            UserLibrary[]
  listeningHistory   ListeningHistory[]
  playbackQueue      PlaybackQueue?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model OAuthProvider {
  id         String @id @default(uuid())
  userId     String @map("user_id")
  name       String @map("name") @unique
  providerId String @map("provider_id") @unique

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("accounts")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

model AuthorizationCode {
  id        String   @id @default(cuid())
  code      String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("authorization_codes")
}

model Artist {
  id            String        @id @default(uuid())
  name          String        @unique
  albums        Album[]
  tracks        TrackArtist[]
  artistArtPath String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("artists")
}

model Album {
  id          String   @id @default(uuid())
  title       String
  artist      Artist   @relation(fields: [artistId], references: [id])
  artistId    String
  releaseYear Int?
  genre       String?
  albumArtKey String?
  tracks      Track[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([title, artistId])
  @@map("albums")
}

model Track {
  id               String             @id @default(uuid())
  title            String
  isPublic         Boolean  @default(false)
  album            Album              @relation(fields: [albumId], references: [id])
  albumId          String
  artists          TrackArtist[]
  trackNumber      Int?
  discNumber       Int?
  duration         Int?
  playCount        Int                @default(0)
  lastPlayedAt     DateTime?
  audioFile        AudioFile?
  playlistTracks   PlaylistTrack[]
  libraryEntries   UserLibrary[]
  listeningHistory ListeningHistory[]
  queueItems       QueueItem[]
  currentInQueues  PlaybackQueue[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@map("tracks")
}

model TrackArtist {
  track    Track  @relation(fields: [trackId], references: [id], onDelete: Cascade)
  trackId  String
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)
  artistId String
  order    Int    @default(0)

  @@id([trackId, artistId])
  @@map("track_artists")
}

model AudioFile {
  id         String   @id @default(uuid())
  track      Track    @relation(fields: [trackId], references: [id])
  trackId    String   @unique
  storageKey String   @unique
  format     String
  bitrate    Int?
  sampleRate Int?
  fileSize   BigInt
  checksum   String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("audio_files")
}

model Playlist {
  id          String   @id @default(uuid())
  name        String
  description String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isPublic    Boolean  @default(false)
  coverImage  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tracks PlaylistTrack[]

  @@index([userId])
  @@map("playlists")
}

model PlaylistTrack {
  id         String   @id @default(uuid())
  playlistId String
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  trackId    String
  track      Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  position   Int
  addedAt    DateTime @default(now())

  @@unique([playlistId, trackId])
  @@index([playlistId])
  @@index([trackId])
  @@map("playlist_tracks")
}

model UserLibrary {
  id      String   @id @default(uuid())
  userId  String
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trackId String
  track   Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  addedAt DateTime @default(now())

  @@unique([userId, trackId])
  @@index([userId])
  @@index([trackId])
  @@map("user_library")
}

model ListeningHistory {
  id       String   @id @default(uuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trackId  String
  track    Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  playedAt DateTime @default(now())
  duration Int?

  @@index([userId, playedAt])
  @@index([trackId])
  @@map("listening_history")
}

model PlaybackQueue {
  id             String     @id @default(uuid())
  userId         String     @unique
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentTrackId  String?
  currentTrack    Track?     @relation(fields: [currentTrackId], references: [id], onDelete: SetNull)
  position       Int        @default(0)
  shuffleEnabled Boolean    @default(false)
  repeatMode     RepeatMode @default(OFF)
  updatedAt      DateTime   @updatedAt

  queueItems QueueItem[]

  @@map("playback_queues")
}

model QueueItem {
  id       String        @id @default(uuid())
  queueId  String
  queue    PlaybackQueue @relation(fields: [queueId], references: [id], onDelete: Cascade)
  trackId  String
  track    Track         @relation(fields: [trackId], references: [id], onDelete: Cascade)
  position Int

  @@index([queueId])
  @@map("queue_items")
}

enum RepeatMode {
  OFF
  ONE
  ALL
}

enum UserRole {
  ADMIN
  USER
}
